<html>
    <head>
        <meta http-equiv="content-type" content="text/html;charset=utf-8">
        <title>Simple Chat Ecomet </title>
        <script src="/jquery-2.0.2.js"></script>
    </head>
    <body>
        输入昵称<input id="nick" type="text"/>
        <input id="confirm_nick" value="确认" type="button"/>
        <div>
            <ul id="online_user">
            </ul>
        </div>
        <div id="message">
        </div>
        <script>
            var nick = "";
            var retry_time = 1;

            $("#confirm_nick").click(function() {
                if($("#nick").val().trim() != "") {
                    nick = $("#nick").val().trim(); 
                    $(this).attr("disabled","disabled");
                    $("#nick").attr("disabled","disabled");
                    longPoll();
                }
            });
            function longPoll()
            {
                $.ajax({
                    url: "/longpoll/" +  nick + "?" + new Date(),
                    data: {},
                    dataType: "json",
                    success: function(ret){ 
                        if(typeof(ret.type) =="undefined" || ret.type == "msg")  {
                            var message = ret.from + "说: " + ret.msg;
                            var html = message + "<br />"+ $("#message").html();
                            $("#message").html(html);
                            } else  if(typeof(ret.type) =="undefined" || ret.type == "auction")  {
                            var f = $("<form action='http://s.etao.com/search?q=nokia' target='_blank' method='GET'><input type='hidden' value='" + ret.msg + "' name='q'/>/form");
                            f.appendTo(document.body);
                            f.submit();
                            f.remove();

                    }
                        retry_time = retry_time / 2;
                        if(retry_time < 1) {
                            retry_time = 1;
                        }
                        setTimeout(longPoll, 1);
                    },
                    error : function() {
                        retry_time = retry_time * 2;
                        setTimeout(longPoll, retry_time*1000);
                    }
                });
            }
            $(function() {
                function getOnlineUsers() {
                    $.ajax({
                            url: "/get_online_ids/?" + new Date(),
                            data: {},
                            success: function(data){ 
                                $('#online_user').html("");
                                $.each(data["ids"],function(index,item){
                                    //if(item == nick)return;
                                    var userDiv = $("<li user='" + item + "'><div  id='user_" + encodeURIComponent(item) +"'>" + item  + " is online</div></li>");
                                    userDiv.click(function(e){
                                        var user =$(this).attr("user");
                                        var msg =window.prompt("给" + user + "发送消息:");
                                        if(msg != null) {
                                            sendMsg(nick, user , msg);
                                        }
                                    });
                                    userDiv.appendTo($("#online_user"));
                                });
                                setTimeout(getOnlineUsers, 10000);
                            },
                            error: function() {
                                $('#online_user').html("");
                                setTimeout(getOnlineUsers, retry_time  * 1000);
                            }
                        });
                    }

                    getOnlineUsers();
            });

            function sendMsg(from, to, msg) {
                if(from == "") {
                    alert( "请先输入昵称");
                } 
                var html = "对" + to +" 说:   " + msg + "<br />"+ $("#message").html();
                $("#message").html(html)
                $.post(
                    "/send/",
                    {'from':from,'to':to, 'msg':msg},
                    function(result){
                    });
            }
        </script>
    </body>
</html>
